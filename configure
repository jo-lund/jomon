#!/bin/bash

DISABLE_GEOIP=0

usage()
{
    echo "Usage: ./configure [option]"
    echo ""
    echo "   --disable-geoip  : Build without libGeoIP"
    echo "   -h, --help       : Display help"
    exit 0
}

check_pkgconf()
{
    echo -n "[*] Checking for pkgconf... "

    command -v pkgconf >/dev/null ||
        {
            echo "FAIL";
            echo;
            echo -n "pkgconf needs to be installed. This can be installed with ";
            echo "\"pacman -S pkgconf\" or equivalent command for your distribution.";
            exit 1;
        }

    echo "OK"
}

check_ncurses()
{
    echo -n "[*] Checking for libncurses... "

    if ! $(pkgconf --exists ncurses); then
        echo "FAIL"
        echo
        echo -n "You need a functioning install of libncurses. "
        echo -n "This can be installed with \"pacman -S ncurses\" or equivalent "
        echo "command for your distribution."
        exit 1
    fi

    echo "OK"
}

check_geoip()
{
    echo -n "[*] Checking for libGeoIP... "

    if ! $(pkgconf --exists geoip); then
        echo "FAIL"
        echo
        echo -n "You need a functioning install of libGeoIP. "
        echo -n "This can be installed with \"pacman -S geoip geoip-database "
        echo "geoip-database-extra\" or equivalent command for your distribution."
        exit 1
    fi

    echo "OK"
}

check_re2c()
{
    echo -n "[*] Checking for re2c... "

    command -v re2c >/dev/null ||
        {
            echo "FAIL";
            echo;
            echo -n "re2c needs to be installed. This can be installed with ";
            echo "\"pacman -S re2c\" or equivalent command for your distribution.";
            exit 1;
        }

    echo "OK"
}

generate_config()
{
    echo "[*] Generating config..."
    echo > config.mk
    echo "#ifndef CONFIG_H" > config.h
    echo "#define CONFIG_H" >> config.h
    echo >> config.h

    if [[ "$DISABLE_GEOIP" == 1 ]]; then
        echo "#define HAVE_GEOIP 0" >> config.h
        echo "CONFIG_GEOIP=0" >> config.mk
    else
        echo "#define HAVE_GEOIP 1" >> config.h
        echo "CONFIG_GEOIP=1" >> config.mk
    fi

    echo >> config.h
    echo "#endif" >> config.h
}

while [ $# -gt 0 ]; do
    case "$1" in
	-h | --help)
	    usage
	    ;;
        --disable-geoip)
            DISABLE_GEOIP=1
            ;;
        *)
            echo "Invalid option. Use -h for help"
            exit 1;
            ;;
    esac
    shift
done

check_pkgconf
check_ncurses
if [[ "$DISABLE_GEOIP" == 0 ]]; then
    check_geoip
fi
check_re2c
generate_config
